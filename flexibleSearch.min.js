/*
 * flexibleSearch.js
 *
 * Copyright (c) Tomohiro Okuwaki / bit part LLC (http://bit-part.net/)
 *
 * Since  : 2010-11-12
 * Update : 2017-03-31
 * Version: 2.2.3
 * Comment: Please use this with Movable Type :)
 *
 * You have to include "mustache.js" before "flexibleSearch.js".
 * Maybe... jQuery 1.7.x later
 *
 */
!function(e){e.fn.flexibleSearch=function(a){function t(e,a,t,n,r){var l=0;if("like"===n){for(var s in a){for(var i=a[s].split(","),o=i.length,c=0,u=-1,d=o;++u<d;){var m=new RegExp(i[u].replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$1"),"i");if("undefined"==typeof e[s]||"string"==typeof e[s]&&m.test(e[s])){if("AND"!==r&&"and"!==r){l++;break}c++}}("AND"===r||"and"===r)&&c===o&&l++}return l===t}for(var s in a)if(e[s]&&"string"==typeof e[s]&&e[s]!==a[s])return!1;return l}function n(e,a){for(var t=a.length,n=0,r=-1;++r<t;){var l=new RegExp(a[r].replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$1"),"i");for(var s in e)if(l.test(e[s])){n++;break}}return t===n}function r(e,a,t,n){(a||"string"==typeof a)&&(t="ascend"===t?-1:1,e.sort(function(e,r){var l=e[a],s=r[a];return"numeric"===n?(l-=0,s-=0):"string"===n&&(l=""+l,s=""+s),s>l?1*t:l>s?-1*t:0}))}var l=e.extend({},e.fn.flexibleSearch.defaults,a),s=this;if(l.searchFormCreation){var i=[],o="";if(null!==l.advancedFormObj&&("hidden"in l.advancedFormObj&&i.push(['<div class="fs-advanced-hidden" style="display:none;">',"{{#hidden}}",'<input type="hidden"','{{#id}} id="{{id}}"{{/id}}','{{#name}} name="{{name}}"{{/name}}','{{#value}} value="{{value}}"{{/value}}>',"{{/hidden}}","</div>"].join("")),"text"in l.advancedFormObj&&i.push(['<div class="fs-advanced-text">',"{{#text}}","{{#label}}",'<label{{#id}} id="{{id}}-label"{{/id}}{{#name}} for="{{name}}"{{/name}} class="fs-text{{#name}} fs-{{name}}{{/name}}">',"{{/label}}",'<input type="text"','{{#id}} id="{{id}}"{{/id}}','{{#name}} name="{{name}}"{{/name}}','{{#value}} value="{{value}}"{{/value}}','{{#placeholder}} placeholder="{{placeholder}}"{{/placeholder}}>',"{{#label}}","{{label}}</label>","{{/label}}","{{/text}}","</div>"].join("")),"checkbox"in l.advancedFormObj&&i.push(['<div class="fs-advanced-checkbox">',"{{#checkbox}}","{{#label}}",'<label{{#id}} id="{{id}}-label"{{/id}}{{#name}} for="{{name}}"{{/name}} class="fs-checkbox{{#name}} fs-{{name}}{{/name}}">',"{{/label}}",'<input type="checkbox"','{{#id}} id="{{id}}"{{/id}}','{{#name}} name="{{name}}"{{/name}}','{{#value}} value="{{value}}"{{/value}}','{{#checked}} checked="checked"{{/checked}}>',"{{#label}}","{{label}}</label>","{{/label}}","{{/checkbox}}","</div>"].join("")),"radio"in l.advancedFormObj&&i.push(['<div class="fs-advanced-radio">',"{{#radio}}","{{#label}}",'<label{{#id}} id="{{id}}-label"{{/id}}{{#name}} for="{{name}}"{{/name}} class="fs-radio{{#name}} fs-{{name}}{{/name}}">',"{{/label}}",'<input type="radio"','{{#id}} id="{{id}}"{{/id}}','{{#name}} name="{{name}}"{{/name}}','{{#value}} value="{{value}}"{{/value}}','{{#checked}} checked="checked"{{/checked}}>',"{{#label}}","{{label}}</label>","{{/label}}","{{/radio}}","</div>"].join("")),o=Mustache.render(i.join(""),l.advancedFormObj),"select"in l.advancedFormObj)){var c={selects:l.advancedFormObj.select,options:function(){for(var e=this.option,a=[],t=0,n=e.length;n>t;t++){var r=e[t].selected?" selected":"";a.push('<option value="'+e[t].value+'"'+r+">"+e[t].label+"</option>")}return a.join("")}},u=['<div class="fs-advanced-select">',"{{#selects}}",'<select{{#id}} id="{{id}}"{{/id}}{{#name}} name="{{name}}"{{/name}}{{#size}} size="{{size}}"{{/size}}{{#multiple}} multiple{{/multiple}} class="fs-select{{#name}} fs-{{name}}{{/name}}">',"{{{options}}}","</select>","{{/selects}}","</div>"].join("");o+=Mustache.render(u,c)}var d={action:l.searchFormAction,type:l.searchFormInputType,placeholder:l.searchFormInputPlaceholder,submitBtnText:l.searchFormSubmitBtnText},m="";if(null!==l.limit&&"number"==typeof l.limit&&(l.paginateCount=l.limit),null!==l.searchFormHTML)m=l.searchFormHTML;else{var h=['<form action="{{action}}" method="GET">','<input type="hidden" name="offset" value="0">','<input type="hidden" name="limit" value="'+l.paginateCount+'">','<input type="{{type}}" name="search" placeholder="{{placeholder}}" class="fs-text fs-search">','<input type="submit" value="{{submitBtnText}}" class="fs-btn fs-submit">',o,"</form>"].join("");m=Mustache.render(h,d)}s[0].innerHTML=m}var p="";null!==l.loadingImgHTML?p=l.loadingImgHTML:l.loadingImgPath&&(p='<span class="fs-loading"><img src="'+l.loadingImgPath+'" alt=""></span>');var f="";f=null!==l.resultMsgTmpl?l.resultMsgTmpl:['<div{{#id}} id="{{id}}"{{/id}}{{#classname}} class="{{classname}}"{{/classname}}>',"<p>","{{#keywords}}「{{keywords}}」が {{/keywords}}","{{#count}}{{count}} 件見つかりました。{{/count}}","{{^count}}見つかりませんでした。{{/count}}","{{#count}}（{{lastPage}} ページ中 {{currentPage}} ページ目を表示）{{/count}}","</p>","</div>"].join("");var g="";g=null!==l.resultItemTmpl?l.resultItemTmpl:['<div id="'+l.resultBlockId+'-items">',"<ul>","{{#items}}","<li>{{&title}}</li>","{{/items}}","</ul>","</div>"].join("");var v="";v=null!==l.paginateTmpl?l.paginateTmpl:['<div{{#id}} id="{{id}}"{{/id}}{{#classname}} class="{{classname}}"{{/classname}}>',"<ul>","{{#showTurnPage}}","{{#exceptFirst}}",'<li class="fs-prev"><span><a class="fs-prev-link fs-turn-page-link" href="#" title="{{prevPageText}}">{{prevPageText}}</a></span></li>',"{{/exceptFirst}}","{{/showTurnPage}}","{{#page}}","{{#checkRange}}",'<li class="{{current}}"{{#hidePageNumber}} style="display:none;"{{/hidePageNumber}}><span><a class="fs-page-link {{currentLink}}" href="#" title="{{pageNumber}}">{{pageNumber}}</a></span></li>',"{{/checkRange}}","{{/page}}","{{#showTurnPage}}","{{#exceptLast}}",'<li class="fs-next"><span><a class="fs-next-link fs-turn-page-link" href="#" title="{{nextPageText}}">{{nextPageText}}</a></span></li>',"{{/exceptLast}}","{{/showTurnPage}}","</ul>","</div>"].join(""),s.find("form").on("submit",function(a){a.preventDefault();for(var t=e(this).attr("action")||location.href.replace(/\?.*/,""),n=e(this).serializeArray(),r=-1,s=n.length;++r<s;)"search"===n[r].name&&(n[r].value=e.trim(n[r].value.replace("　"," ")));n=l.submitAction(n);var i=e.param(n);return i&&(t=t+"?"+i),location.href=t,!1});var b=decodeURIComponent(location.search.replace(/^\?/,""));if(""===b&&null!==l.initialParameter&&"string"==typeof l.initialParameter&&(b=decodeURIComponent(l.initialParameter.replace(/^\?/,""))),""===b){switch(typeof l.searchDataPathPreload){case"string":e.ajax({type:"GET",cache:!0,dataType:"json",url:l.searchDataPathPreload});break;case"object":if(null===l.searchDataPathPreload||""===l.searchDataPathPreload)break;if(l.searchDataPathPreload.length)for(var y=-1,P=l.searchDataPathPreload.length;++y<P;)e.ajax({type:"GET",cache:!0,dataType:"json",url:l.searchDataPathPreload[y]});else for(var T in l.searchDataPathPreload)e.ajax({type:"GET",cache:!0,dataType:"json",url:l.searchDataPathPreload[T]})}return!1}p&&(document.getElementById(l.resultBlockId).innerHTML=p);var x=[],M=b.split(/&|%26/),k={},I=[],j={},N=0,w=null!==l.limit&&"number"==typeof l.limit?l.limit:10,L="",R="",C="",F="",D="",S=!1,H=["search","dataId","offset","limit","sortBy","sortOrder","sortType"];null!==l.excludeParams&&e.merge(H,l.excludeParams.toLowerCase().split(","));for(var y=-1,P=M.length;++y<P;){var A=M[y].split("="),T=A[0],O=A[1]||"";switch(k[T]=O,T){case"search":O="+"===O?"":O,x=O.split(/\+| |%20/);break;case"offset":N=O;break;case"limit":w=null!==l.limit&&"number"==typeof l.limit?l.limit:O;break;case"dataId":D=O;break;case"sortBy":L=O.toLowerCase();break;case"sortOrder":R=O.toLowerCase();break;case"sortType":C=O.toLowerCase()}if("offset"!==T&&"limit"!==T){if(s.find("[name='"+T+"']").each(function(){var a=this.tagName.toLowerCase();switch(a){case"input":var t=e(this).attr("type");"checkbox"===t&&e(this).val()===O?e(this).prop("checked",!0):"radio"===t&&e(this).val()===O?e(this).prop("checked",!0):("text"===t||"search"===t||"hidden"===t)&&e(this).val("search"===T?O.replace("+"," "):O);break;case"select":e(this).find("option").each(function(){e(this).val()===O?e(this).prop("selected",!0):""===O&&" "===e(this).val()&&e(this).prop("selected",!0)})}}),""!==O){if(O=O.replace(/\+/g," "),-1!==e.inArray(T,H))continue;-1!==e.inArray(T,I)?j[T]+=","+O:j[T]=O}I.push(T)}}var B=0;for(var T in j)B++;switch(typeof l.searchDataPath){case"string":F=l.searchDataPath;break;case"object":if(""===D)return void window.alert("dataId is required.");null!==l.dataApiDataIds&&-1!==e.inArray(D,l.dataApiDataIds.split(","))&&(S=!0,null!==l.dataApiParams&&(b+=""!==b?"&"+e.param(l.dataApiParams):e.param(l.dataApiParams))),F=l.searchDataPath[D]}S&&(F+="?"+b),e.ajax({type:"GET",cache:l.cache,dataType:"json",url:F,error:function(e,a,t){l.ajaxError(e,a,t)},success:function(a){var s={};if(S)s=a;else{var i=e.grep(a.items,function(){return!0});i=e.grep(i,function(e,a){return t(e,j,B,"like",l.advancedSearchCond)}),i=e.grep(i,function(e,a){return n(e,x)}),null!==l.customSearch&&"function"==typeof l.customSearch&&(i=e.grep(i,function(e,a){return l.customSearch(e,k)}));var o=Number(w)+Number(N);s.totalResults=i.length,0!==s.totalResults&&""!==L&&L in i[0]&&("ascend"!==R&&(R="descend"),"numeric"!==C&&(C="string"),r(i,L,R,C)),null!==l.customSort&&"function"==typeof l.customSort&&(i=l.customSort(i)),s.items=e.grep(i,function(e,a){return N>a?!1:a>=o?!1:!0})}var c,u,d=Math.ceil(N/w)+1,m=Math.ceil(s.totalResults/w),h=l.maxPageCount?l.maxPageCount:100,p=h%2==0?h/2-1:Math.floor(h/2),b=h%2==0?h/2:Math.floor(h/2);h>=m?(c=1,u=m):(c=d-p,u=d+b,1>c?(c=1,u=h):u>m&&(b=m-d,u=m,p=h-b,c=d-p));for(var y=[],P=0,T=m;++P<=T;)y.push({pageNumber:P});var M={id:l.paginateId,classname:l.paginateClassName,page:y,hidePageNumber:l.hidePageNumber,showTurnPage:l.showTurnPage,prevPageText:l.prevPageText,nextPageText:l.nextPageText,isFirst:function(){return 1===d},isLast:function(){return y.length?d===y.length:!0},exceptFirst:function(){return 1!==d},exceptLast:function(){return y.length>0&&d!==y.length},checkRange:function(){return this.pageNumber>=c&&this.pageNumber<=u},current:function(){return this.pageNumber===d?"fs-current":this.pageNumber===d-1?"fs-current-prev":this.pageNumber===d+1?"fs-current-next":""},lastPage:function(){return M.page.length},currentLink:function(){return this.pageNumber===d?"fs-current-link":this.pageNumber===d-1?"fs-current-prev-link":this.pageNumber===d+1?"fs-current-next-link":""},currentCountFrom:function(){return N-0+1},currentCountTo:function(){var e=N-0+w,a=e<s.totalResults?e:s.totalResults;return a-0},totalResults:s.totalResults,count:s.totalResults,currentPage:d},I=Mustache.render(v,M),F={id:l.resultMsgId?l.resultMsgId:"",classname:l.resultMsgClassName?l.resultMsgClassName:"",keywords:x.join(", "),keywordArray:""!==x.join("")?x:null,count:s.totalResults,metaTitle:document.title,firstPage:function(){return M.page[0].pageNumber},lastPage:function(){return M.page.length},currentPage:d},D=Mustache.render(f,F);if(l.resultMetaTitleRewrite){var H=l.resultMetaTitleTmpl?l.resultMetaTitleTmpl:["{{#keywordArray}}{{.}} {{/keywordArray}}","{{#count}} {{count}}件{{/count}}","{{#count}} {{currentPage}}/{{lastPage}}{{/count}}","{{#metaTitle}} | {{metaTitle}}{{/metaTitle}}"].join(""),A=Mustache.render(H,F);document.title=A}null!==l.modifyResultJSON&&"function"==typeof l.modifyResultJSON&&(s=l.modifyResultJSON(s));var O=Mustache.render(g,s);null!==l.modifyResultMsgHTML&&"function"==typeof l.modifyResultMsgHTML&&(D=l.modifyResultMsgHTML(D)),null!==l.modifyResultItemHTML&&"function"==typeof l.modifyResultItemHTML&&(O=l.modifyResultItemHTML(O)),null!==l.modifyPaginateHTML&&"function"==typeof l.modifyPaginateHTML&&(I=l.modifyPaginateHTML(I));var E="";if(null===l.resultMsgInsertMethods&&(E+=D),E+=O,null===l.paginateInsertMethods&&(E+=I),document.getElementById(l.resultBlockId).innerHTML=E,null!==l.resultMsgInsertMethods)for(var P=0,z=l.resultMsgInsertMethods.length;z>P;P++)e(l.resultMsgInsertMethods[P].selector)[l.resultMsgInsertMethods[P].method](D);if(null!==l.paginateInsertMethods)for(var P=0,z=l.paginateInsertMethods.length;z>P;P++)e(l.paginateInsertMethods[P].selector)[l.paginateInsertMethods[P].method](I);null!==l.resultComplete&&"function"==typeof l.resultComplete&&l.resultComplete(s.totalResults);var G=l.paginateId?"#"+l.paginateId:"."+l.paginateClassName;e(G).on("click","a.fs-page-link",function(a){a.preventDefault();var t=e(this).attr("title"),n=(Number(t)-1)*Number(w);n="offset="+n;var r=location.href.replace(/\?.*/g,""),s=location.search?location.search.replace(/^\?/,""):l.initialParameter;s=s.replace(/offset=[0-9]+/,n),-1===s.indexOf("offset=")&&(s+="&"+n),s=s.replace(/&offset=0/,""),location.href=r+"?"+s}).on("click","a.fs-turn-page-link",function(a){a.preventDefault(),e(this).hasClass("fs-prev-link")?e(a.delegateTarget).find(".fs-current-prev-link").trigger("click"):e(this).hasClass("fs-next-link")&&e(a.delegateTarget).find(".fs-current-next-link").trigger("click")})}})},e.fn.flexibleSearch.defaults={initialParameter:null,limit:null,searchDataPath:"/flexibleSearch/search.json",searchDataPathPreload:null,dataApiDataIds:null,dataApiParams:null,cache:!0,searchFormCreation:!0,searchFormHTML:null,searchFormAction:"",searchFormInputType:"search",searchFormInputPlaceholder:"Search words",searchFormSubmitBtnText:"Search",advancedFormObj:null,advancedSearchCond:"OR",loadingImgPath:"/flexibleSearch/loading.gif",loadingImgHTML:null,resultBlockId:"fs-result",resultItemTmpl:null,resultMsgId:null,resultMsgClassName:"fs-result-msg",resultMsgTmpl:null,resultMetaTitleRewrite:!0,resultMetaTitleTmpl:null,resultMsgInsertMethods:null,paginateId:null,paginateClassName:"fs-paginate",paginateTmpl:null,paginateCount:10,hidePageNumber:!1,showTurnPage:!0,prevPageText:"Prev",nextPageText:"Next",maxPageCount:10,paginateInsertMethods:null,submitAction:function(e){return e},ajaxError:function(e,a,t){window.alert(a)},customSearch:null,modifyResultJSON:null,modifyResultMsgHTML:null,modifyResultItemHTML:null,modifyPaginateHTML:null,resultComplete:null,excludeParams:null,dummy:!1}}(jQuery);
